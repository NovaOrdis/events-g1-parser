#!/bin/bash

function build-classpath() {

    local found=false
    for i in $(find $(dirname $0)/../target -name *.jar); do
        [[ "${i}" =~ -source ]] && continue;
        found=true
        echo ${i}
    done

    ${found} || { echo "no *.jar file found in $(dirname $0)/../target" 1>&2; exit 1; }
}

function get-events-api-version() {

    local pom_file=$(dirname $0)/../pom.xml

    [ -f ${pom_file} ] || { echo "POM file ${pom_file} not found" 1>&2; exit 1; }

    local version
    version=$(grep "<events\.api\.version>" ${pom_file}) || { echo "<events.api.version> not found" 1>&2; exit 1; }

    version=${version#*>}
    version=${version%?/events*}
    echo ${version}
}

function get-novaordis-utilities() {

    local pom_file=$(dirname $0)/../pom.xml

    [ -f ${pom_file} ] || { echo "POM file ${pom_file} not found" 1>&2; exit 1; }

    local version
    version=$(grep "<novaordis\.utilities\.version>" ${pom_file}) || { echo "<novaordis.utilities.version> not found" 1>&2; exit 1; }

    version=${version#*>}
    version=${version%?/novaordis*}
    echo ${version}
}

function main() {

    local args;
    local debug_args;

    while [ -n "$1" ]; do

        if [ "$1" = "-d" ]; then
            debug_args="-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005";
        else
            args="${args} $1"
        fi

        shift
    done

    local cp
    cp=$(build-classpath) || exit 1

    local events_api_version
    events_api_version=$(get-events-api-version) || exit 1

    local novaordis_utilities_version
    novaordis_utilities_version=$(get-novaordis-utilities) || exit 1

    cp="${cp}:\
${M2}/io/novaordis/utilities/novaordis-utilities/${novaordis_utilities_version}/novaordis-utilities-${novaordis_utilities_version}.jar:\
${M2}/io/novaordis/events/api/events-api/${events_api_version}/events-api-${events_api_version}.jar:\
${M2}/org/slf4j/slf4j-api/1.7.6/slf4j-api-1.7.6.jar:\
${M2}/org/slf4j/slf4j-log4j12/1.7.6/slf4j-log4j12-1.7.6.jar:\
${M2}/log4j/log4j/1.2.17/log4j-1.2.17.jar"

    java ${debug_args} -cp ${cp} io.novaordis.events.gc.Main ${args}

}

main $@



